# Hybrid Deployment Plan: Aspire Python + Docker for Scenario 6 Frontend

## Problem Statement

Currently, the Scenario 6 AppHost always uses Docker to run both services (moshi backend and frontend), regardless of whether running in development or production mode. This creates slower iteration cycles during development for the **frontend** FastAPI app (requires container rebuild on every code change) while providing excellent production consistency.

## Proposed Approach

Implement a **hybrid orchestration strategy** for the **frontend service only**:
- **Development**: Use Aspire Python integration (`AddUvicornApp`) for fast iteration, native debugging, and hot reload  
- **Production**: Use Docker container (`AddDockerfile`) for consistency and deployment

The **moshi backend** remains Docker-only in both modes due to its complexity (vendored third-party code, custom startup scripts).

The switch is controlled by `builder.ExecutionContext.IsPublishMode`:
- `false` = local dev (frontend → Aspire Python, moshi → Docker)
- `true` = production publish (both → Docker)

## Workplan

### Phase 1: Prerequisites & Validation
- [ ] Verify Aspire.Hosting.Python NuGet package is installed in AppHost project
- [ ] Document Python environment requirements for developers (venv, PyTorch, dependencies)
- [ ] Test current Docker setup still works (baseline)

### Phase 2: Frontend Development Mode Implementation  
- [ ] Add conditional logic in `scenario6/AppHost/Program.cs` based on `IsPublishMode`
- [ ] Implement `AddUvicornApp` configuration for frontend development mode:
  - [ ] Set project directory to `..` (scenario6 root)
  - [ ] Set app name to `app:app`
  - [ ] Configure HTTP endpoint on port 8010 (default APP_PORT)
  - [ ] Set environment variables: `PYTHONUNBUFFERED`, `APP_PORT`, `APP_HOST`
  - [ ] Configure `MOSHI_WS_URL` reference to moshi backend endpoint
  - [ ] Set `HF_TOKEN` parameter reference
  - [ ] Add health check endpoint (`/health`)
- [ ] Configure virtual environment handling:
  - [ ] Add `.WithVirtualEnvironment("../venv")` to use existing venv (created by setup_scenario6.py)
  - [ ] Add `.WithPip()` for package management

### Phase 3: Production Mode Retention
- [ ] Keep existing `AddDockerfile` configuration for frontend in production mode (IsPublishMode = true)
- [ ] Ensure all Docker settings remain unchanged:
  - [ ] HTTP endpoint configuration
  - [ ] OTEL exporter integration
  - [ ] Wait dependencies on moshi backend
  - [ ] All environment variables
- [ ] Keep moshi backend as Docker-only in BOTH modes (too complex for Aspire Python)

### Phase 4: Service Discovery Configuration
- [ ] Ensure frontend references work for both modes:
  - [ ] Verify `MOSHI_WS_URL` environment variable injection (moshi.GetEndpoint())
  - [ ] Test service discovery for both Python and Docker frontend resources
  - [ ] Confirm `WaitFor(moshi)` works with both frontend resource types

### Phase 5: Documentation
- [ ] Update `scenario6/README.md` with hybrid approach explanation
- [ ] Add developer setup instructions for Aspire Python mode:
  - [ ] Python 3.10-3.12 requirement
  - [ ] Run `setup_scenario6.py` script to create venv
  - [ ] Install system dependencies (libopus-dev)
  - [ ] Install PyTorch with CUDA (optional, if using GPU)
- [ ] Document how to switch modes:
  - [ ] Dev: `aspire run` (automatically uses Python for frontend)
  - [ ] Prod: `dotnet publish` or Azure deployment (uses Docker for both)
- [ ] Add troubleshooting section for common Aspire Python issues
- [ ] Update AppHost/README.md with mode descriptions

### Phase 6: Testing
- [ ] Test development mode (IsPublishMode = false):
  - [ ] Verify frontend starts via Aspire Python
  - [ ] Verify moshi backend starts via Docker
  - [ ] Test `/health` endpoint responds on frontend
  - [ ] Test `/api/config` endpoint returns moshi connection info
  - [ ] Verify hot reload works (change frontend code, see update without restart)
  - [ ] Confirm web UI loads and can connect to moshi WebSocket
  - [ ] Check Aspire dashboard shows correct endpoints
- [ ] Test production mode (IsPublishMode = true):
  - [ ] Verify both Docker containers build and run
  - [ ] Test same endpoints work identically
  - [ ] Verify OTEL integration works
  - [ ] Confirm SSL/TLS certificate generation for moshi
- [ ] Test voice conversation end-to-end in both modes

### Phase 7: Developer Experience Enhancements (Optional)
- [ ] Add script to validate Python environment before running Aspire
- [ ] Create `.vscode/launch.json` configuration for debugging frontend Python via Aspire
- [ ] Add error message if venv doesn't exist (guide user to run setup_scenario6.py)
- [ ] Consider adding `WithUv()` instead of `WithPip()` for faster installs

## Implementation Notes

### Code Structure
The main change will be in `scenario6/AppHost/Program.cs`:

```csharp
// Current:
var frontend = builder.AddDockerfile("scenario6-frontend", "..", "Dockerfile")...

// New:
IResourceBuilder<IResourceWithEndpoints> frontend;

if (builder.ExecutionContext.IsPublishMode)
{
    // Production: Docker container for frontend
    frontend = builder.AddDockerfile("scenario6-frontend", "..", "Dockerfile")
        .WithImageTag("latest")
        .WithEnvironment("APP_PORT", appPort.ToString())
        .WithEnvironment("APP_HOST", "0.0.0.0")
        .WithEnvironment("MOSHI_WS_URL", moshi.GetEndpoint(moshiEndpointName))
        .WithHttpEndpoint(port: appPort, targetPort: 8010, name: "http")
        .WithOtlpExporter()
        .WaitFor(moshi);
}
else
{
    // Development: Aspire Python for frontend
    frontend = builder.AddUvicornApp("scenario6-frontend", "..", "app:app")
        .WithHttpEndpoint(port: appPort, env: "APP_PORT")
        .WithHttpHealthCheck("/health")
        .WithVirtualEnvironment("../venv")
        .WithPip()
        .WithEnvironment("PYTHONUNBUFFERED", "1")
        .WithEnvironment("APP_HOST", "0.0.0.0")
        .WithEnvironment("MOSHI_WS_URL", moshi.GetEndpoint(moshiEndpointName))
        .WithReference(hfToken)
        .WithOtlpExporter()
        .WaitFor(moshi);
}

// Moshi backend stays Docker-only in both modes
var moshi = builder.AddDockerfile("scenario6-moshi", "..", "moshi/Dockerfile")
    .WithImageTag("latest")
    .WithEnvironment("HF_TOKEN", hfToken)
    // ... rest of configuration unchanged
```

### Architecture for Both Modes

**Development Mode:**
```
Browser → Frontend (Aspire Python, port 8010)
             ↓
          Moshi Backend (Docker, port 8998, WSS)
             ↓
          PersonaPlex-7B-v1 Model
```

**Production Mode:**
```
Browser → Frontend (Docker, port 8010)
             ↓
          Moshi Backend (Docker, port 8998, WSS)
             ↓
          PersonaPlex-7B-v1 Model
```

### Environment Variable Mapping
| Variable | Docker Value | Aspire Python Value |
|----------|--------------|---------------------|
| `APP_PORT` | `8010` (via env) | `8010` (via `WithHttpEndpoint`) |
| `APP_HOST` | `0.0.0.0` | `0.0.0.0` |
| `MOSHI_WS_URL` | Via `moshi.GetEndpoint()` | Via `moshi.GetEndpoint()` |
| `HF_TOKEN` | Via parameter reference | Via parameter reference |
| `PYTHONUNBUFFERED` | `1` | `1` |

### Prerequisites for Developers
To use Aspire Python mode for frontend, developers must:
1. Have Python 3.10-3.12 installed
2. Run `python scenario6/setup_scenario6.py` to create venv and install dependencies
3. Install system dependencies (libopus-dev on Linux, Visual Studio Build Tools on Windows)
4. Have HF_TOKEN configured (via user secrets or environment)
5. Have Docker running (for moshi backend)

### Fallback Strategy
If Aspire Python setup fails for frontend, developers can:
1. Force Docker mode by setting an environment variable
2. Use Docker Desktop to run both containers traditionally
3. Follow existing Docker instructions in README

### GPU Considerations
- **Moshi backend (Docker in both modes)**: Uses `--gpus=all` runtime arg for GPU passthrough
- **Frontend (Python or Docker)**: No GPU required, only serves web UI and proxies config
- Both modes require NVIDIA drivers on host machine for moshi backend
- `USE_GPU` configuration flag controls GPU passthrough to moshi container

### Service Discovery
Both `AddDockerfile` and `AddUvicornApp` return `IResourceBuilder<IResourceWithEndpoints>`, so moshi backend references work identically:
```csharp
.WithEnvironment("MOSHI_WS_URL", moshi.GetEndpoint(moshiEndpointName))
```

### Testing Strategy
- Use `dotnet run` to test development mode (frontend: Aspire Python, moshi: Docker)
- Use `dotnet publish` to test production mode (both: Docker)
- Verify end-to-end voice conversation works in both modes
- Test hot reload in development mode (change frontend code, observe instant update)

## Success Criteria

- [ ] Developers can run `aspire run` and get fast Python iteration for frontend without Docker rebuild
- [ ] Moshi backend continues to work via Docker in both modes
- [ ] Production deployments still use Docker containers for both services
- [ ] Both modes pass identical integration tests (voice conversation works end-to-end)
- [ ] Documentation clearly explains setup for both modes
- [ ] No breaking changes to existing functionality

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Developers skip venv setup | Add validation script that checks for `venv` before starting |
| Environment drift between modes | Document identical dependency versions; add integration tests |
| Aspire Python path issues | Use `..` as project directory (scenario6 root); verify app.py is found |
| Model cache path differences | Use consistent HF_TOKEN and HF_HOME across modes |
| Aspire Python debugging issues | Provide VS Code launch.json; document debugging workflow |
| WebSocket connection issues | Ensure MOSHI_WS_URL is correctly propagated in both modes |

## Future Enhancements

- Auto-detect if `venv` exists, else fall back to Docker for frontend
- Add `--dev-mode` CLI flag to override IsPublishMode
- Create health check script to validate Python environment
- Add telemetry to track which mode is used most
- Consider extending to other scenarios with similar patterns

## References

- Aspire Python Integration: https://aspire.dev/integrations/frameworks/python/
- Current Docker setup: `scenario6/moshi/Dockerfile`, `scenario6/Dockerfile`
- Setup script: `scenario6/setup_scenario6.py`
- AppHost code: `scenario6/AppHost/Program.cs`
- PersonaPlex Model: https://huggingface.co/nvidia/personaplex-7b-v1
