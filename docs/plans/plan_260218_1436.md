# Hybrid Deployment Plan: Aspire Python + Docker for FastAPI Server

## Problem Statement

Currently, the Scenario 4 AppHost always uses Docker to run the Python FastAPI server, regardless of whether running in development or production mode. This creates slower iteration cycles during development (requires container rebuild on every code change) while providing excellent production consistency.

## Proposed Approach

Implement a hybrid orchestration strategy that:
- **Development**: Uses Aspire Python integration (`AddUvicornApp`) for fast iteration, native debugging, and hot reload
- **Production**: Uses Docker container (`AddDockerfile`) for consistency, GPU isolation, and Azure deployment

The switch is controlled by `builder.ExecutionContext.IsPublishMode`:
- `false` = local dev (Aspire Python)
- `true` = production publish (Docker)

## Workplan

### Phase 1: Prerequisites & Validation
- [ ] Verify Aspire.Hosting.Python NuGet package is installed in AppHost project
- [ ] Document Python environment requirements for developers (venv, CUDA, PyTorch, NeMo)
- [ ] Test current Docker setup still works (baseline)

### Phase 2: Development Mode Implementation
- [ ] Add conditional logic in `AppHost/Program.cs` based on `IsPublishMode`
- [ ] Implement `AddUvicornApp` configuration for development mode:
  - [ ] Set project directory to `../server`
  - [ ] Set app name to `app:app`
  - [ ] Configure HTTP endpoint on port 8000
  - [ ] Set `PYTHONUNBUFFERED=1` environment variable
  - [ ] Configure `HF_HOME` to use user's local cache directory
  - [ ] Set `APPLICATIONINSIGHTS_CONNECTION_STRING` reference
  - [ ] Add health check endpoint (`/health`)
- [ ] Configure virtual environment handling:
  - [ ] Add `.WithVirtualEnvironment("../server/.venv")` to use existing venv
  - [ ] Add `.WithPip()` for package management

### Phase 3: Production Mode Retention
- [ ] Keep existing `AddDockerfile` configuration in production mode (IsPublishMode = true)
- [ ] Ensure all Docker settings remain unchanged:
  - [ ] GPU passthrough (`--gpus=all`)
  - [ ] Volume mounts for model cache
  - [ ] Container lifetime persistence
  - [ ] All environment variables

### Phase 4: Client Configuration Updates
- [ ] Ensure webapp client references work for both modes:
  - [ ] Verify `services__apiserver__http__0` environment variable injection
  - [ ] Test service discovery for both Python and Docker resources
  - [ ] Confirm `WaitFor(apiServer)` works with both resource types

### Phase 5: Documentation
- [ ] Update `scenario4/README.md` with hybrid approach explanation
- [ ] Add developer setup instructions for Aspire Python mode:
  - [ ] Python 3.10-3.12 requirement
  - [ ] Run `server/setup-venv.ps1` script
  - [ ] Verify CUDA/GPU setup
  - [ ] Run `fix_lhotse.py` post-install
- [ ] Document how to switch modes:
  - [ ] Dev: `dotnet run` (automatically uses Python)
  - [ ] Prod: `dotnet publish` or Azure deployment (uses Docker)
- [ ] Add troubleshooting section for common Aspire Python issues

### Phase 6: Testing
- [ ] Test development mode (IsPublishMode = false):
  - [ ] Verify server starts via Aspire Python
  - [ ] Test `/health` endpoint responds
  - [ ] Test `/transcribe` endpoint with sample audio
  - [ ] Verify hot reload works (change code, see update without restart)
  - [ ] Confirm GPU access works natively
  - [ ] Check Aspire dashboard shows correct endpoints
- [ ] Test production mode (IsPublishMode = true):
  - [ ] Verify Docker container builds and runs
  - [ ] Test same endpoints work identically
  - [ ] Confirm GPU passthrough works
  - [ ] Verify model cache persists via volume
- [ ] Test webapp client integration with both modes
- [ ] Test NIM LLM container still works alongside both modes

### Phase 7: Developer Experience Enhancements (Optional)
- [ ] Add script to validate Python environment before running Aspire
- [ ] Create `.vscode/launch.json` configuration for debugging Python via Aspire
- [ ] Add error message if venv doesn't exist (guide user to run setup)
- [ ] Consider adding `WithUv()` instead of `WithPip()` for faster installs

## Implementation Notes

### Code Structure
The main change will be in `AppHost/Program.cs`:

```csharp
// Current:
var apiServer = builder.AddDockerfile("apiserver", "../server")...

// New:
IResourceBuilder<IResourceWithEndpoints> apiServer;

if (builder.ExecutionContext.IsPublishMode)
{
    // Production: Docker container
    apiServer = builder.AddDockerfile("apiserver", "../server")
        .WithImageTag("latest")
        .WithHttpEndpoint(targetPort: 8000, name: "http")
        .WithHttpHealthCheck("/health")
        .WithEnvironment("PYTHONUNBUFFERED", "1")
        .WithEnvironment("HF_HOME", "/root/.cache/huggingface")
        .WithEnvironment("APPLICATIONINSIGHTS_CONNECTION_STRING", appInsights)
        .WithVolume("hf-model-cache", "/root/.cache/huggingface")
        .WithContainerRuntimeArgs("--gpus=all")
        .WithLifetime(ContainerLifetime.Persistent);
}
else
{
    // Development: Aspire Python
    apiServer = builder.AddUvicornApp("apiserver", "../server", "app:app")
        .WithHttpEndpoint(port: 8000, env: "PORT")
        .WithHttpHealthCheck("/health")
        .WithVirtualEnvironment("../server/.venv")
        .WithPip()
        .WithEnvironment("PYTHONUNBUFFERED", "1")
        .WithEnvironment("HF_HOME", Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), 
            ".cache", "huggingface"))
        .WithReference(appInsights);
}
```

### Environment Variable Mapping
| Variable | Docker Value | Aspire Python Value |
|----------|--------------|---------------------|
| `HF_HOME` | `/root/.cache/huggingface` | `%USERPROFILE%\.cache\huggingface` |
| `PORT` | N/A (uses uvicorn default) | `8000` (via `WithHttpEndpoint`) |
| `PYTHONUNBUFFERED` | `1` | `1` |
| `APPLICATIONINSIGHTS_CONNECTION_STRING` | Via `WithEnvironment` | Via `WithReference` |

### Prerequisites for Developers
To use Aspire Python mode, developers must:
1. Have Python 3.10-3.12 installed
2. Run `scenario4/server/setup-venv.ps1` to create `.venv`
3. Have CUDA toolkit installed for GPU support
4. Run `fix_lhotse.py` after venv setup

### Fallback Strategy
If Aspire Python setup fails, developers can:
1. Set environment variable to force Docker mode
2. Use Docker Desktop to run traditional container
3. Follow existing Docker instructions in README

### GPU Considerations
- **Docker mode**: Uses `--gpus=all` runtime arg for GPU passthrough
- **Aspire Python mode**: Direct host GPU access (requires CUDA installed locally)
- Both modes require NVIDIA drivers on host machine

### Service Discovery
Both `AddDockerfile` and `AddUvicornApp` return `IResourceBuilder<IResourceWithEndpoints>`, so client references work identically:
```csharp
.WithEnvironment("services__apiserver__http__0", apiServer.GetEndpoint("http"))
```

### Testing Strategy
- Use `dotnet run --publish-mode false` to force development mode (if needed)
- Use `dotnet publish` to test production mode locally
- Azure deployments automatically use IsPublishMode = true

## Success Criteria

- [ ] Developers can run `dotnet run` and get fast Python iteration without Docker
- [ ] Production deployments still use Docker containers
- [ ] Both modes pass identical integration tests
- [ ] Documentation clearly explains setup for both modes
- [ ] No breaking changes to existing functionality

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Developers skip venv setup | Add validation script that checks for `.venv` before starting |
| Environment drift between modes | Document identical dependency versions; add integration tests |
| GPU setup varies across machines | Provide detailed CUDA setup guide; Docker always works as fallback |
| Model cache path differences | Use consistent cache locations; document where models are stored |
| Aspire Python debugging issues | Provide VS Code launch.json; document debugging workflow |

## Future Enhancements

- Auto-detect if `.venv` exists, else fall back to Docker
- Add `--dev-mode` CLI flag to override IsPublishMode
- Create health check script to validate Python environment
- Add telemetry to track which mode is used most
- Consider Aspire Python for NIM LLM container as well (if feasible)

## References

- Aspire Python Integration: https://aspire.dev/integrations/frameworks/python/
- Current Docker setup: `scenario4/server/Dockerfile`
- Setup script: `scenario4/server/setup-venv.ps1`
- AppHost code: `scenario4/AppHost/Program.cs`
