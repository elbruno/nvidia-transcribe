@page "/transcribe"
@inject TranscriptionApiService ApiService
@inject ILogger<Transcribe> Logger
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Transcribe Audio</PageTitle>

<div class="transcribe-container">
    <h1>üéôÔ∏è Audio Transcription</h1>
    
    <!-- Section 1: File Selection (Always Visible) -->
    <div class="section section-file">
        <h2>üìÅ Select Audio File</h2>
        <div class="file-selection-content">
            <div class="file-drop-zone">
                <InputFile id="file-input" 
                           OnChange="HandleFileSelected" 
                           accept=".wav,.mp3,.flac"
                           class="file-input-overlay" />
                <div class="file-select-label">
                    <span class="upload-icon">üìÅ</span>
                    <span class="upload-text">Click to select a file or drag and drop here</span>
                    <span class="supported-formats">Supported: WAV, MP3, FLAC (max 50MB)</span>
                </div>
            </div>
            
@*             @if (!string.IsNullOrEmpty(selectedFileName))
            { *@
                <div class="selected-file-info">
                    <div class="file-icon">üéµ</div>
                    <div class="file-details">
                        <div class="file-name">@selectedFileName</div>
                        <div class="file-size">@FormatFileSize(selectedFileSize)</div>
                    </div>
                    <button class="btn-clear" @onclick="ClearFile" title="Clear file">‚úï</button>
                </div>
            @* } *@
        </div>
    </div>

    <!-- Section 2: Transcription Configuration -->
    <div class="section section-config">
        <h2>‚öôÔ∏è Configuration Options</h2>
        <div class="config-grid">
            <div class="config-option">
                <label for="modelSelect">ASR Model:</label>
                <select id="modelSelect" @bind="selectedModelKey" @bind:after="OnModelChanged" class="config-select">
                    <option value="parakeet">Parakeet (English, with timestamps)</option>
                    <option value="canary">Canary-1B (Multilingual, no timestamps)</option>
                </select>
            </div>
            
            <div class="config-option">
                <label for="languageSelect">Language:</label>
                <select id="languageSelect" @bind="selectedLanguageCode" class="config-select" disabled="@(!IsLanguageSelectionEnabled)">
                    <option value="en">English (en)</option>
                    <option value="es">Spanish (es)</option>
                    <option value="de">German (de)</option>
                    <option value="fr">French (fr)</option>
                </select>
                @if (!IsLanguageSelectionEnabled)
                {
                    <small class="config-hint">Language selection available only for Canary model</small>
                }
            </div>
            
            <div class="config-option">
                <label for="timestampCheck">
                    <input type="checkbox" id="timestampCheck" @bind="requestTimestamps" disabled="@(!CanGenerateTimestamps)" />
                    Generate Timestamps
                </label>
                @if (!CanGenerateTimestamps)
                {
                    <small class="config-hint">Timestamps not supported by selected model</small>
                }
            </div>
        </div>
    </div>

    <!-- Section 3: Start Transcribing (Always Visible, Always Enabled) -->
    <div class="section section-action">
        <button class="btn-transcribe" @onclick="TranscribeAudio" disabled="@isProcessing">
            @if (isProcessing)
            {
                <span class="spinner-small"></span>
                <span>Processing...</span>
            }
            else
            {
                <span>‚ñ∂Ô∏è Start Transcription</span>
            }
        </button>
        
        @if (isProcessing && !string.IsNullOrEmpty(currentJobId))
        {
            <button class="btn-cancel" @onclick="CancelJob">
                <span>‚èπÔ∏è Cancel Job</span>
            </button>
        }
    </div>

    <!-- Section 4: Transcription Result (Multiline Textbox) -->
    <div class="section section-result">
        <h2>üìÑ Transcription Result</h2>
        <textarea class="result-textarea" 
                  readonly 
                  placeholder="Transcription will appear here..."
                  value="@transcriptionText"></textarea>
    </div>

    <!-- Section 5: Progress Log (Console Style) -->
    <div class="section section-log">
        <h2>üìã Progress Log</h2>
        <div class="console-log" @ref="logElement">
            @foreach (var log in progressLogs)
            {
                <div class="log-entry @log.Level">
                    <span class="log-timestamp">[@log.Timestamp.ToString("HH:mm:ss")]</span>
                    <span class="log-message">@log.Message</span>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private IBrowserFile? selectedFile;
    private string selectedFileName = string.Empty;
    private long selectedFileSize = 0;
    private bool isProcessing = false;
    private string transcriptionText = string.Empty;
    private List<LogEntry> progressLogs = new();
    private ElementReference logElement;
    private string? currentJobId;
    
    // Configuration fields for new features
    private string selectedModelKey = "parakeet";
    private string selectedLanguageCode = "en";
    private bool requestTimestamps = true;
    
    // Computed properties for UI state
    private bool IsLanguageSelectionEnabled => selectedModelKey == "canary";
    private bool CanGenerateTimestamps => selectedModelKey == "parakeet";
    
    private void OnModelChanged()
    {
        // Reset timestamp option when switching models
        if (selectedModelKey == "parakeet")
        {
            requestTimestamps = true;
        }
        else if (selectedModelKey == "canary")
        {
            requestTimestamps = false;
        }
        
        AddLog($"Model changed to: {selectedModelKey}", "info");
    }
    
    private void RecordLogEntry(string msg, string severity) => AddLog(msg, severity);

    protected override void OnInitialized()
    {
        AddLog("System ready. Select an audio file to begin.", "info");
    }

    public void Dispose()
    {
        // Cleanup if needed
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        selectedFileName = e.File.Name;
        selectedFileSize = e.File.Size;
        
        AddLog($"File selected: {e.File.Name} ({FormatFileSize(e.File.Size)})", "success");
        StateHasChanged();
    }

    private void ClearFile()
    {
        selectedFile = null;
        selectedFileName = string.Empty;
        selectedFileSize = 0;
        transcriptionText = string.Empty;
        currentJobId = null;
        AddLog("File cleared", "info");
        StateHasChanged();
    }

    private async Task TranscribeAudio()
    {
        if (selectedFile == null)
        {
            AddLog("‚ö†Ô∏è Error: No file selected. Please select a file first.", "error");
            return;
        }

        if (isProcessing)
        {
            AddLog("‚ö†Ô∏è Warning: Transcription already in progress.", "warning");
            return;
        }

        isProcessing = true;
        transcriptionText = string.Empty;
        StateHasChanged();

        try
        {
            AddLog($"Starting async transcription job for: {selectedFile.Name}", "info");
            AddLog($"Configuration: Model={selectedModelKey}, Language={selectedLanguageCode}, Timestamps={requestTimestamps}", "info");
            AddLog("Uploading file to server...", "info");
            
            // Start async job with configuration parameters
            // Note: Pass null for language when using Parakeet (English-only) to avoid server validation errors
            var jobStart = await ApiService.StartTranscriptionJobAsync(
                selectedFile, 
                selectedModelKey, 
                IsLanguageSelectionEnabled ? selectedLanguageCode : null,
                requestTimestamps);
            currentJobId = jobStart.JobId;
            
            AddLog($"‚úì Upload complete - Job ID: {currentJobId}", "success");
            AddLog($"Job status: {jobStart.Status}", "info");
            AddLog("Monitoring job progress...", "info");
            
            // Poll for job completion
            await PollJobStatus(currentJobId);
        }
        catch (Exception ex)
        {
            AddLog($"‚úó Error: {ex.Message}", "error");
            Logger.LogError(ex, "Transcription job failed");
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task PollJobStatus(string jobId)
    {
        const int maxAttempts = 120; // 10 minutes with 5-second intervals
        int attempts = 0;

        while (attempts < maxAttempts && isProcessing)
        {
            try
            {
                await Task.Delay(5000); // Poll every 5 seconds
                
                var jobInfo = await ApiService.GetJobStatusAsync(jobId);
                
                if (jobInfo.Status == "completed")
                {
                    AddLog("‚úì Job completed! Retrieving results...", "success");
                    
                    var result = await ApiService.GetJobResultAsync(jobId);
                    transcriptionText = result.Text;
                    
                    AddLog($"‚úì Transcription complete! ({result.Segments?.Length ?? 0} segments)", "success");
                    
                    if (!string.IsNullOrEmpty(result.Text))
                    {
                        AddLog($"Total text length: {result.Text.Length} characters", "info");
                    }
                    
                    AddLog("Ready for next transcription", "success");
                    isProcessing = false;
                    break;
                }
                else if (jobInfo.Status == "failed")
                {
                    AddLog($"‚úó Job failed: {jobInfo.Error ?? "Unknown error"}", "error");
                    isProcessing = false;
                    break;
                }
                else if (jobInfo.Status == "cancelled")
                {
                    AddLog("Job was cancelled", "warning");
                    isProcessing = false;
                    break;
                }
                else
                {
                    // Still processing
                    if (attempts % 6 == 0) // Log progress every 30 seconds
                    {
                        AddLog($"Job status: {jobInfo.Status} (elapsed: {attempts * 5}s)", "info");
                    }
                }
                
                attempts++;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                AddLog($"‚úó Error polling job status: {ex.Message}", "error");
                Logger.LogError(ex, "Failed to poll job status");
                isProcessing = false;
                break;
            }
        }

        if (attempts >= maxAttempts)
        {
            AddLog("‚ö†Ô∏è Job polling timeout. The job may still be processing on the server.", "warning");
            isProcessing = false;
        }

        StateHasChanged();
    }

    private async Task CancelJob()
    {
        if (string.IsNullOrEmpty(currentJobId))
        {
            AddLog("‚ö†Ô∏è No active job to cancel", "warning");
            return;
        }

        try
        {
            AddLog($"Cancelling job: {currentJobId}", "info");
            var result = await ApiService.CancelJobAsync(currentJobId);
            AddLog($"‚úì {result.Message}", "success");
            isProcessing = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            AddLog($"‚úó Error cancelling job: {ex.Message}", "error");
            Logger.LogError(ex, "Failed to cancel job");
        }
    }

    private void AddLog(string message, string level = "info")
    {
        progressLogs.Add(new LogEntry
        {
            Timestamp = DateTime.Now,
            Message = message,
            Level = level
        });
        
        // Keep only last 100 entries
        if (progressLogs.Count > 100)
        {
            progressLogs.RemoveAt(0);
        }
        
        StateHasChanged();
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    private class LogEntry
    {
        public DateTime Timestamp { get; set; }
        public string Message { get; set; } = string.Empty;
        public string Level { get; set; } = "info";
    }
}

<style>
    .transcribe-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .transcribe-container h1 {
        color: #333;
        border-bottom: 3px solid #76b900;
        padding-bottom: 10px;
        margin-bottom: 30px;
        font-size: 2rem;
    }

    /* Section Styling */
    .section {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .section h2 {
        color: #333;
        font-size: 1.3rem;
        margin: 0 0 15px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
    }

    /* Section 1: File Selection */
    .section-file {
        border-left: 4px solid #76b900;
    }

    .file-drop-zone {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        background: #fafafa;
        position: relative;
    }

    .file-input-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    .file-drop-zone:hover,
    .file-drop-zone.drag-over {
        border-color: #76b900;
        background: rgba(118, 185, 0, 0.05);
    }

    .file-select-label {
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

    .upload-icon {
        font-size: 3rem;
    }

    .upload-text {
        font-size: 1.1rem;
        color: #333;
        font-weight: 500;
    }

    .supported-formats {
        font-size: 0.9rem;
        color: #666;
    }

    .selected-file-info {
        margin-top: 15px;
        padding: 15px;
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        border: 2px solid #76b900;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 15px;
        position: relative;
    }

    .file-icon {
        font-size: 2.5rem;
        background: white;
        width: 60px;
        height: 60px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .file-details {
        flex: 1;
    }

    .file-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        word-break: break-all;
    }

    .file-size {
        font-size: 0.9rem;
        color: #666;
        margin-top: 4px;
    }

    .btn-clear {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 26px;
        height: 26px;
        border: none;
        background: rgba(0,0,0,0.1);
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        color: #666;
        transition: all 0.2s;
    }

    .btn-clear:hover {
        background: #ff5252;
        color: white;
    }

    /* Section 2: Configuration Options */
    .section-config {
        border-left: 4px solid #ff9800;
    }

    .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 15px;
    }

    .config-option {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .config-option label {
        font-weight: 600;
        color: #555;
        font-size: 0.95rem;
    }

    .config-select {
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }

    .config-select:hover:not(:disabled) {
        border-color: #ff9800;
    }

    .config-select:focus {
        outline: none;
        border-color: #ff9800;
        box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
    }

    .config-select:disabled {
        background: #f5f5f5;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .config-hint {
        color: #888;
        font-size: 0.85rem;
        font-style: italic;
    }

    .config-option input[type="checkbox"] {
        width: 18px;
        height: 18px;
        margin-right: 8px;
        cursor: pointer;
    }

    .config-option input[type="checkbox"]:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }

    /* Section 3: Action Button */
    .section-action {
        border-left: 4px solid #2196f3;
        text-align: center;
    }

    .btn-transcribe {
        padding: 18px 50px;
        font-size: 1.3rem;
        font-weight: 600;
        background: linear-gradient(135deg, #76b900 0%, #5a8a00 100%);
        border: none;
        border-radius: 50px;
        color: white;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 15px rgba(118, 185, 0, 0.4);
        transition: all 0.3s ease;
    }

    .btn-transcribe:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(118, 185, 0, 0.5);
    }

    .btn-transcribe:active:not(:disabled) {
        transform: translateY(0);
    }

    .btn-transcribe:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-cancel {
        padding: 18px 40px;
        font-size: 1.2rem;
        font-weight: 600;
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        border: none;
        border-radius: 50px;
        color: white;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        transition: all 0.3s ease;
        margin-left: 20px;
    }

    .btn-cancel:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.5);
    }

    .btn-cancel:active {
        transform: translateY(0);
    }

    .spinner-small {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    /* Section 4: Result Textbox */
    .section-result {
        border-left: 4px solid #ff9800;
    }

    .result-textarea {
        width: 100%;
        min-height: 200px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 1rem;
        line-height: 1.6;
        resize: vertical;
        background: #fafafa;
        color: #333;
    }

    .result-textarea:focus {
        outline: none;
        border-color: #ff9800;
        box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
    }

    .result-textarea::placeholder {
        color: #999;
        font-style: italic;
    }

    /* Section 5: Console Log */
    .section-log {
        border-left: 4px solid #9c27b0;
    }

    .console-log {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 15px;
        border-radius: 8px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.9rem;
        line-height: 1.5;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
    }

    .log-entry {
        padding: 4px 0;
        display: flex;
        gap: 10px;
    }

    .log-timestamp {
        color: #858585;
        font-weight: 600;
    }

    .log-message {
        flex: 1;
    }

    .log-entry.info .log-message {
        color: #4fc3f7;
    }

    .log-entry.success .log-message {
        color: #81c784;
    }

    .log-entry.warning .log-message {
        color: #ffb74d;
    }

    .log-entry.error .log-message {
        color: #e57373;
    }

    /* Scrollbar for console */
    .console-log::-webkit-scrollbar {
        width: 8px;
    }

    .console-log::-webkit-scrollbar-track {
        background: #2d2d2d;
        border-radius: 4px;
    }

    .console-log::-webkit-scrollbar-thumb {
        background: #555;
        border-radius: 4px;
    }

    .console-log::-webkit-scrollbar-thumb:hover {
        background: #777;
    }

    /* Animations */
    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @@media (max-width: 768px) {
        .transcribe-container {
            padding: 10px;
        }

        .section {
            padding: 15px;
        }

        .btn-transcribe {
            padding: 14px 30px;
            font-size: 1.1rem;
        }

        .file-drop-zone {
            padding: 25px;
        }
    }
</style>
